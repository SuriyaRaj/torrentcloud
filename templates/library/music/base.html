<html>
<head>
<title>{% block title %}Library - Music{% endblock %}</title>
<link href="/css/bootstrap.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="stylesheet" type="text/css" href="/css/library.css">


<script src='/js/jquery-1.10.2.js'></script>
<script src="/js/soundmanager2.js"></script>
<script>

	function Queue(songs) {
		this.songs = new Object();
		this.sounds = new Object();
		this.queue = new Array();

		this.queueIndex = 0;

		songs.forEach(function(song) {
			this.songs[song.hash] = song;
			this.sounds[song.hash] = soundManager.createSound({
				url: "/" + song.url,
			});
		}, this);
	}

	Queue.prototype.clear = function() {
		this.queue = [];
	};

	Queue.prototype.reset = function() {
		this.queueIndex = 0;
	};

	Queue.prototype.load = function(songHashes) {
		this.clear();
		songHashes.forEach(function(songHash) {
			this.add(songHash);
		}, this);
	};

	Queue.prototype.add = function(songHash) {
		this.queue.push(songHash);
	};

	Queue.prototype.play = function(songHash) {
		var sound = this.sounds[songHash];
		if(sound == undefined) {

		}
		var queue = this;
		sound.play({
			onplay: function() {
				queue.queueIndex = queue.queue.indexOf(songHash);
				queue.displayCurrentSong(songHash);
				$("#play-pause-button").attr("class", "icon-pause icon-2x");
				$("#"+ songHash + " > .playing").css("background-image", "url(/images/equalizer.gif)");
			},
			onfinish: function() {
				$("#"+ songHash + " > .playing").css("background-image", "");
				queue.playNext();
			}
		});
	};

	Queue.prototype.resume = function() {
		var songHash = this.queue[this.queueIndex];
		var sound = this.sounds[songHash];
		if(sound != undefined) {
			if(sound.playState == 0) {
				this.play(songHash);
			} else {
				sound.resume();
			}
			$("#play-pause-button").attr("class", "icon-pause icon-2x");
			$("#"+ songHash + " > .playing").css("background-image", "url(/images/equalizer.gif)");
		}
	};

	Queue.prototype.stop = function() {
		var songHash = this.queue[this.queueIndex];
		var sound = this.sounds[songHash];
		if(sound != undefined) {
			sound.stop();
			$("#"+ songHash + " > .playing").css("background-image", "");
			$("#play-pause-button").attr("class", "icon-play icon-2x");
		}
	}

	Queue.prototype.pause = function() {
		var songHash = this.queue[this.queueIndex];
		var sound = this.sounds[songHash];
		if(sound != undefined) {
			sound.pause();
			$("#"+ songHash + " > .playing").css("background-image", "");
			$("#play-pause-button").attr("class", "icon-play icon-2x");
		}
	}
	
	Queue.prototype.playNext = function() {
		this.stop();
		var nextSongIndex = this.queueIndex + 1;
		if(nextSongIndex < this.queue.length) {
			this.queueIndex = nextSongIndex
			var songHash = this.queue[this.queueIndex];
			this.play(songHash);
		}
		else {
			$("#play-pause-button").attr("class", "icon-play icon-2x");
			this.reset();
		}
	}

	Queue.prototype.playPrevious = function() {
		this.stop();
		var prevSongIndex = this.queueIndex - 1;
		if(prevSongIndex >= 0) {
			var songHash = this.queue[prevSongIndex];
			this.play(songHash);
		}
	}

	Queue.prototype.nowPlaying = function() {
		var songHash = this.queue[this.queueIndex];
		if(songHash == undefined) {
			return null;
		} else {
			return songHash;
		}
	}

	Queue.prototype.displayCurrentSong = function(songHash) {
		var song = this.songs[songHash];
		var artist = song.artist;
		var album = song.album;
		var title = song.title;
		var artwork = "/" + albumArtwork[album];
		$('#player-album-artwork').attr('src', artwork);
		$("#player-song-info").html(title+"<br>" + artist + " - " + album);


	}

	var audioFiles;
	var songs;
	var queue;

	soundManager.setup({

	    // where to find the SWF files, if needed
	    url: '/includes/swf/soundmanager2/',

	    // if you'd rather have 100% HTML5 mode (where supported)
	    preferFlash: false,

	    onready: function() {
	    	songs = {% block songs %}{% endblock %};
	    	queue = new Queue(songs);
	    },

	    ontimeout: function() {
	      // Uh-oh. SWF missing, Flash blocked or other issue
	    }

	});

	var albumArtwork = {% block albumArtwork %}{% endblock %};

	window.onpopstate = function(event) {
		$("#media-content").html(event.state.html);
		console.log(history.state);
	}

	$(document).ready(function() {
		var originalPage = {html: $("#media-content").html()};
		history.replaceState(originalPage, "", "");

		var songsOnDeck;
		$('#play-pause-button').click(function() {
			if($(this).hasClass("icon-play")) {
				queue.resume();
			}
			else if($(this).hasClass("icon-pause")) {
				queue.pause();
			}
		});

		$('#next-button').click(function() {
			queue.playNext();
		});

		$('#previous-button').click(function() {
			queue.playPrevious();
		});

		$("#media-category-menu li").click(function() {
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
		});

		$("#music-category").click(function() {
			$.ajax({
               type: "GET",
               url: "/library/music/",
               success: function(html) {
					$('#media-content').html(html);
               }
             });
		});

		$(document).on("click", ".artist-listing", function() {
			var artist = $(this).attr('id');
			var oldHtml = $("#media-content").html();
			$.ajax({
               type: "GET",
               url: "/library/music/artists/" + artist + "/",
               success: function(html) {
					$('#media-content').html(html);
					var state = {html: html};
					history.pushState(state, "", artist+"/");
               }
             });
		});

		$(document).on("click", ".album-listing", function() {
			var artist = $(this).parent().attr('id');
			var album = $(this).attr('id');
			var playingSongHash = queue.nowPlaying();
			$.ajax({
               type: "GET",
               url: "/library/music/artists/" + artist + "/" + album + "/",
               success: function(html) {
               		$('#media-content').html(html);
					var state = {html: html};
					history.pushState(state, "", album + "/");
               }
             });
		});

		$(document).on("click", ".song-listing", function() {
			var songHashes = new Array();
			var songHash = $(this).attr('id');
			$(".song-container").find(".song-listing").each(function() {
				songHashes.push(this.id);
			});
			queue.stop();
			queue.load(songHashes);
			queue.play(songHash);
		});
	});
</script>
</head>
<body>
	 <nav class="navbar navbar-default" role="navigation">
	  <!-- Brand and toggle get grouped for better mobile display -->
	  <div class="navbar-header">
	    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
	      <span class="sr-only">Toggle navigation</span>
	      <span class="icon-bar"></span>
	      <span class="icon-bar"></span>
	      <span class="icon-bar"></span>
	    </button>
	    <a class="navbar-brand" href="#">Torrent Cloud</a>
	  </div>

	  <!-- Collect the nav links, forms, and other content for toggling -->
	  <div class="collapse navbar-collapse navbar-ex1-collapse">
	    <ul class="nav navbar-nav">
	      <li><a href="cloud.php">My Cloud</a></li>
	      <li class="active"><a href="library.php">Library</a></li>
	      <li><a href="#contact">Friends</a></li>
	    </ul>
	    <form class="navbar-form navbar-right" role="search">
	      <div class="form-group">
	        <input type="text" class="form-control" placeholder="Search">
	      </div>
	      <button type="submit" class="btn btn-default">Submit</button>
	    </form>
	  </div><!-- /.navbar-collapse -->
	</nav>
	
	<div class='full container'>
		<div class='row'>
			<!--<div style="text-align:center" class='col-lg-2'>
			<button class="btn btn-default btn-block" id="openDownload">Download</button>
			<button  class='btn btn-default btn-block' id='removeTorrents'>Remove</button>
			</div>-->
			<div class="col-lg-1">
				<ul id="media-category-menu" class="nav nav-pills nav-stacked">
					<li id='music-category' class="active"><a>Music</a></li>
					<li id='movie-category'><a>Movies</a></li>
					<li id='tv-category'><a>TV Shows</a></li>
				</ul>

			</div>
			<div id='media-content' class="col-lg-11">
				{% block content %}{% endblock %}
			</div>
			
		</div>


		<nav id='player' class="navbar navbar-default navbar-fixed-bottom" role="navigation">
			<div class='row'>
				<div id='song-info' class='col-lg-4'>
					<img id='player-album-artwork' src="about:blank">
					<span id='player-song-info'></span>
				</div>
				<div id='player-controls' class='col-lg-4 text-center'>
					<i id='previous-button' class="icon-fast-backward icon-2x"></i>
					<i id='play-pause-button' class="icon-play icon-2x"></i>
					<i id='next-button' class="icon-fast-forward icon-2x"></i>
				</div>
			</div>
		</nav>

		
    </div>
</body>
</html>